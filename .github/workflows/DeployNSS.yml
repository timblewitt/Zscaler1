#
# This workflow deploys the Zscaler NSS infrastructure.
#
# 
#
#

name: Zscaler-NSS-Deploy

on:
  push:
    branches: [ none ]
  workflow_dispatch:

jobs:
  build-and-deploy-nss:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
    
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CREDENTIALS.clientId }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CREDENTIALS.clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_CREDENTIALS.subscriptionId }}
      ARM_TENANT_ID: ${{ secrets.AZURE_CREDENTIALS.tenantId }}
    
    steps:
      - name: Check out repository under $GITHUB_WORKSPACE, so job can access it
        uses: actions/checkout@v3

      - name: Log on to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Terraform CLI
        uses: hashicorp/setup-terraform@v2    
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: |
          cd './tf'
          dir
          terraform init

      - name: Terraform Plan 
        run: |
          cd './tf'
          dir 
          terraform plan
